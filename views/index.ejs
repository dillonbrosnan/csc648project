<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">


<head>
  <% include partials/head %>
  <link rel="stylesheet" href="css/index.css"></link>
</head>

<body>

  <% include partials/header %>

    <section class="container">
  <!-- search component -->
    <div class="left-half">
    <article>
    <section class="leftHandSide">
    <input type="textarea" name="query" id="query">
    <input type="button" name="submit" onclick="createMarkers()" value="Look for address">
    <div id="map"></div>
    <script>
    
    var map;
    var startLatLng = {lat: 37.4220, lng: -122.0841};
    var markers = [];
    var listingObjects = []; 

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: startLatLng,
        zoom: 5
      });
    }

    function createMarkers(){
      var data = <%- JSON.stringify(data) %>
      let query = document.getElementById("query").value;
      var infowindow = new google.maps.InfoWindow();
      if(listingObjects.length){
        listingObjects = []; 
      }
      while(markers.length > 0){
        markers[markers.length-1].setMap(null);
        markers.pop();
      }
      for(let i = 0; i < data.length; i++){
        if(data[i].city.toLowerCase() == query){
          let lat1 = parseFloat(data[i].lat);
          let lng1 = parseFloat(data[i].lon);
          var myLatLng={lat: lat1, lng: lng1};
          listingObjects.push(data[i]);
          marker = new google.maps.Marker({
            map: map,
            position: myLatLng,
            title: data[i].streetNumber + ' ' + data[i].streetName
          });
          markers.push(marker);
          google.maps.event.addListener(marker, 'click', function(){
            infowindow.setContent('<div onclick="getInfo(this.innerHTML)">' +  data[i].streetNumber + ' ' + data[i].streetName + '</div>');
            infowindow.open(map,this);
          }); 
        }
      }
      showImage();
    }

function createInfoBox(jsonListing){
  //getting parent element to append child elements into it
    let parent = document.getElementsByClassName('row text-center')[0]; 
    
    //check parent children nodes to clear the right side out
    while(parent.hasChildNodes()){
        parent.removeChild(parent.lastChild); 

    }
     parent.lastChild = ''; 

    for(let i = 0; i < jsonListing.length; i++){

        //getting data from objects 
        let city    = jsonListing[i].city, 
            price   = jsonListing[i].price, 
            address = jsonListing[i].address, 
            zipcode = jsonListing[i].zipcode; 

            //creating elements 
        let div       = document.createElement('DIV'), 
            childDiv  = document.createElement('DIV'), 
            aTag      = document.createElement("A"),
            img       = document.createElement('IMG'), 
            pTag      = document.createElement('P'), 
            strongTag = document.createElement('STRONG'), 
            pTagg     = document.createElement('P'); 

            
        div.className       = "col-sm-4", 
        childDiv.className  = "thumbnail", 
        img.alt             = i, 
        img.src             ="image.png", 
        img.width           = '900', 
        img.height          = "300", 
        aTag.src            = "#"; 

        //console.log(parent)
        parent.appendChild(div),
        div.appendChild(childDiv); 
        childDiv.appendChild(aTag); 
        aTag.appendChild(img); 
        childDiv.appendChild(pTag);
        pTag.appendChild(strongTag);
        pTag.appendChild(pTagg); 
        childDiv.appendChild(pTagg); 

        var priceNode   = document.createTextNode(price); 
        strongTag.appendChild(priceNode); 

        var addressNode = document.createTextNode(address); 
        pTagg.appendChild(addressNode); 
    }
}

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPXF-zkLqKND8w5ktBN5bdlTkQSVbw950&callback=initMap"
    async defer></script>
  </section>
      </article>
  </div>
  <!--end of result section -->
  <!--result section -->
    <div class="right-half">
      <article>
        <h1>Right Half</h1>
        <script>
          function showImage(){
            var data = <%- JSON.stringify(data) %>
            console.log(data[0].imageID);
          }
        </script>
        <div class="row text-center">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>City</th>
                <th>Price</th>
                <th>Address</th>
                <th>Zip Code</th>
                <th>ImageId</th>
              </tr>
            </thead>
            <tbody>
              <% if(typeof data !== 'undefined') { %>
                <% for(var i=0; i<data.length; i++) { %>
                  <tr>
                    <td><%= data[i].city %></td>
                    <td><%= data[i].price %></td>
                    <td><%= data[i].streetNumber %> <%= data[i].streetName %></td>
                    <td><%= data[i].postalCode %></td>
                    <td><%= data[i].imageId %></td>
                  </tr>
                <% } %>
              <% } %>
            </tbody>
          </table>

        <div class="container text-center">
        <a href="#"><h2>More Listings...></h2</a>
        </div>
        
      </article>
    </div>
  <!--end of result section -->

</section>

  <hr>

    <footer>
      <% include partials/footer %>
    </footer>
  </div> <!-- /container -->

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</body>
</html>