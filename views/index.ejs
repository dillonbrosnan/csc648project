<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">


<head>
  <% include partials/head %>
  <link rel="stylesheet" href="css/index.css"></link>
</head>

<body>

  <% include partials/header %>

    <section class="container">
  <!-- search component -->
    <div class="left-half">
    <article>
          <section class="leftHandSide">
            <div>
              <input type="text" name="query" id="query" value="" list="availableOptions" placeholder="San Francisco">
              <datalist id="availableOptions">
                <option value="San Francisco"></option>
                <option value="San Mateo"></option>
                <option value="San Carlos"></option>
                <option value="San Diego"></option>
                <option value="San Francisco"></option>
                <option value="Daly City"></option>
                <option value="Riverside"></option>
                <option value="Los Angeles"></option>
                <option value="Santa Barbra"></option>
                <option value="Los Banos"></option>
              </datalist>
            </div>
            <input type="button" name="submit" id="submit" onclick="createMarkers()" value="Look for address">
            
            <div id="map"></div>
            <script>

            var mapCities = {}; 
            var startLatLng = {lat: 37.7749, lng: -122.4194};
            var markers = [];
            var listingObjects = []; 
            var query;
            var currentQuery = document.getElementsByClassName('row text-center')[0]; 
            var searchAmount = 0; 
            var availableCities = ['san francisco', 'san mateo', 'san jose', 'riverside', 'daly city', 'los angeles']; 
            
            function clearListings(){
              let parent = document.getElementsByClassName('row text-center')[0];
              while(parent.hasChildNodes){
              
               if(parent.children.length == 0){
                createMarkers(); 
                  break; 
                }

                parent.removeChild(parent.lastChild); 
              }
            }

            function initMap() {
              map = new google.maps.Map(document.getElementById('map'), {
                center: startLatLng,
                zoom: 11
              });
            }

            function createMarkers(){
              var data = <%- JSON.stringify(data) %>
              var streetCity = convertAddress(); 
              
              query = document.getElementById("query").value;
              var infowindow = new google.maps.InfoWindow();

              if(listingObjects.length){
                listingObjects = []; 
              }

              while(markers.length > 0){
                markers[markers.length-1].setMap(null);
                markers.pop();
              }
              
              for(let i = 0; i < data.length; i++){
                if(data[i].city.toLowerCase() == query.toLowerCase() || data[i].city.toLowerCase() == streetCity.toLowerCase()){
                  
                  let lat1 = parseFloat(data[i].lat);
                  let lng1 = parseFloat(data[i].lon);
                  var myLatLng={lat: lat1, lng: lng1};
                
                  listingObjects.push(data[i]);
                
                  marker = new google.maps.Marker({
                    map: map,
                    position: myLatLng,
                    title: data[i].streetNumber + ' ' + data[i].streetName
                  });
                
                  markers.push(marker);
                
                  google.maps.event.addListener(marker, 'click', function(){
                    infowindow.setContent('<div onclick="getInfo(this.innerHTML)">' +  data[i].streetNumber + ' ' + data[i].streetName + '</div>');
                    infowindow.open(map,this);
                  }); 
                }
              }
              
              createInfoBox(streetCity); 

              searchAmount++; 
            }

          /*
          The convert() will take a string of an address 
          it will split the string into its streetNumber, streetName, streetType, streetCity
          Then, 
          The variable url will be used to make an api call using ajax to google maps api to get information about that specific address


          */
        function convertAddress(){
          let fullAddress = document.getElementById("query").value;
          fullAddress = fullAddress.split(' '); 

          console.log(fullAddress); 

          var temp          = parseInt(fullAddress[0]), 
              streetNumber, 
              streetName, 
              streetCity, 
              streetType, 
              streetCitypart1, 
              streetCityPart2, url; 

          if(!isNaN(temp)){
           
            streetNumber = fullAddress[0], 
            streetName   = fullAddress[1], 
            streetType   = fullAddress[2]; 

            //determine what type of city
            if(fullAddress[4] != undefined && fullAddress[4] != ''){
              streetCitypart1   = fullAddress[3]; 
              streetCityPart2   = fullAddress[4]; 

             url = 'https://maps.googleapis.com/maps/api/geocode/json?address=' + streetNumber + '+' + streetName + '+' +streetType+',+'+ streetCitypart1 + '+'+ streetCityPart2 +',+CA&key=AIzaSyBPXF-zkLqKND8w5ktBN5bdlTkQSVbw950'; 

            } else if(fullAddress[4] == undefined && fullAddress[3] != ''){
             streetCity   = fullAddress[3]; 

              url = 'https://maps.googleapis.com/maps/api/geocode/json?address=' + streetNumber + '+' + streetName + '+' +streetType+',+'+ streetCity +',+CA&key=AIzaSyBPXF-zkLqKND8w5ktBN5bdlTkQSVbw950'; 

            } else {
              streetCity = 'san+francisco'; 

              url = 'https://maps.googleapis.com/maps/api/geocode/json?address=' + streetNumber + '+' + streetName + '+' +streetType+',+'+ streetCity +',+CA&key=AIzaSyBPXF-zkLqKND8w5ktBN5bdlTkQSVbw950'; 
            }

          
             $.ajax({
                type: 'GET', 
                url: url, 
                dataType: 'json', 
                success: processJSON
              });
          } 

          return streetCitypart1 + ' ' + streetCityPart2; 
        }

        function processJSON(json){
          console.log(json.results[0]);
        } 

        //selfy funcion that is checking if input is zero 
        //if the input is zero then this function will trigger and remove all listings
           $(document).ready(function(){
              $('#query').keyup(function(){
                var s = $(this).val(); 
                let parent = document.getElementById('result'); 
                let regex = /[s]/g;

                  if(s.length == 0){
                    clearListings(); 
                  } 
                })
           }); 

         function createInfoBox(){
          var data = <%- JSON.stringify(data) %>
          
                //getting parent element to append child elements into it
             let parent = document.getElementsByClassName('row text-center')[0]; 
            
             //check parent children nodes to clear the right side out
             while(parent.hasChildNodes()){
                 parent.removeChild(parent.lastChild); 

             }

            parent.lastChild = ''; 

             for(let i = 0; i < data.length; i++){
               if(data[i].city.toLowerCase() == query.toLowerCase()){
                 //getting data from objects 
                 let city    = data[i].city, 
                     price   = data[i].price, 
                     address = data[i].streetNumber + ' ' + data[i].streetName + ', ' + data[i].city + ' ' + data[i].postalCode, 
                     zipcode = data[i].zipcode; 

                 //creating elements 
                 let div   = document.createElement('DIV'), 
                 childDiv  = document.createElement('DIV'), 
                 aTag      = document.createElement("A"),
                 img       = document.createElement('IMG'), 
                 pTag      = document.createElement('P'), 
                 strongTag = document.createElement('STRONG'), 
                 pTagg     = document.createElement('P'); 

                    
                 div.className       = "col-sm-4", 
                 childDiv.className  = "thumbnail", 
                 img.alt             = i; 

                 let suffix = data[i].imageId.toString();
                 let src = 'saleImages/' + suffix + '.jpg';

                 img.src = src,  
                 img.width           = '900', 
                 img.height          = "300", 
                 aTag.src            = "#"; 

                 //console.log(parent)
                 parent.appendChild(div),
                 div.appendChild(childDiv); 
                 childDiv.appendChild(aTag); 
                 aTag.appendChild(img); 
                 childDiv.appendChild(pTag);
                 pTag.appendChild(strongTag);
                 pTag.appendChild(pTagg); 
                 childDiv.appendChild(pTagg); 

                 var priceNode   = document.createTextNode(price); 
                 strongTag.appendChild(priceNode); 

                 var addressNode = document.createTextNode(address); 
                 pTagg.appendChild(addressNode); 
             } 
           }
         }

            </script>
          <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPXF-zkLqKND8w5ktBN5bdlTkQSVbw950&callback=initMap"
          async defer></script>
        </section>
      </article>
  </div>


    <div class="right-half">
      <div class="row text-center"></div>
    </div>
</section>


  <hr>
    <footer>
      <% include partials/footer %>
    </footer>
  </div> <!-- /container -->

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</body>
</html>